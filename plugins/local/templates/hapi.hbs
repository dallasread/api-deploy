try {
    require.resolve('aws-sdk');
    require.resolve('hapi');
} catch(e) {
    console.error('Unmet dependencies, please run:', 'npm install aws-sdk hapi');
    process.exit(e.code);
}

var AWS = require('aws-sdk'),
    Hapi = require('hapi'),
    server = new Hapi.Server();

AWS.config.update({
    region: '{{aws.region}}'
});

AWS.config.credentials = new AWS.SharedIniFileCredentials({
    profile: '{{aws.profile}}'
});

server.connection({
    host: '{{local.host}}',
    port: {{local.port}},
    routes: { cors: true }
});

{{#each methods}}
    {{#if data.x-api-deploy}}
        {{#if data.x-api-deploy.sdk.method}}
(function () {
    var endpoint = require('{{data.x-amazon-lambda.handler}}');

    server.route({
        method: '{{_method}}',
        path: '{{_path}}',
        handler: function (request, reply) {
            var context = {
                    done: function(err, data) {
                        if (err) data = { error: err.message };
                        reply(null, data);
                    },
                    succeed: function(data) {
                        reply(null, data);
                    },
                    fail: function(err) {
                        reply(null, { error: err.message });
                    }
                },
                event = ('{{_method}}' === 'GET' ? request.query : request.payload) || {},
                key;

            for (key in request.headers) {
                event[key] = request.headers[key];
            }

            for (key in request.params) {
                event[key] = request.params[key];
            }

            endpoint.handler(event, context);
        }
    });
}());
        {{/if}}
    {{/if}}
{{/each}}

server.start(function (err) {
    if (err) throw err;
    console.log('Server running at:', server.info.uri);
});
