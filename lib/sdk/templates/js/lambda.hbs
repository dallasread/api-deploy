var AWS = window.AWS,
    API;

var creds = new AWS.CognitoIdentityCredentials({
    IdentityPoolId: '{{defaults.aws.IdentityPoolId}}'
});

AWS.config.update({
    region: '{{defaults.aws.region}}',
    credentials: creds
});

creds.get(function (err, data) {
    API.debug && err && console.warn(err);
});

var lambda = new AWS.Lambda();

function invoke(func, payload, done) {
    lambda.invoke({
        FunctionName: func,
        Payload: JSON.stringify(payload)
    }, function(err, data) {
        var payload;

        if (API.debug) console.log(err, data);

        if (err) return done(err);

        try {
            payload = JSON.parse(data.Payload);
        } catch (e) {}

        if ('errorMessage' in payload) return done(payload.errorMessage);

        done(null, payload);
    });
}

API = {
    debug: false,

{{#each methods}}
    {{#if x-api-deploy}}
        {{#if x-api-deploy.sdk.method}}
    {{x-api-deploy.sdk.method}}: function {{x-api-deploy.sdk.method}}(data, done) {
    {{#if x-amazon-lambda.arn}}
        invoke('{{lambda.id}}', data, done);
    {{else}}
        this.debug && console.warn('Lambda not deployed:', '{{sdk.method}}');
    {{/if}}
    },
        {{/if}}
    {{/if}}
{{/each}}
};

if (window) window.{{sdk.name}} = API;
module.exports = API;
