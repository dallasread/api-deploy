module.exports = function {{sdk.name}}(config) {
    require('aws-sdk');

    var AWS = window.AWS,
        API;

    var creds = AWS.config.credentials = new AWS.CognitoIdentityCredentials({
        IdentityPoolId: '{{aws.IdentityPoolId}}'
    });

    AWS.config.update(config);

    var lambda = new AWS.Lambda();

    function invoke(func, payload, done) {
        lambda.invoke({
            FunctionName: func,
            Payload: JSON.stringify(payload)
        }, function(err, data) {
            var payload;

            if (API.debug) console.log(arguments);

            if (err) return done(err);

            try {
                payload = JSON.parse(data.Payload);
            } catch (e) {}

            if ('errorMessage' in payload) return done(payload.errorMessage);

            done(null, payload);
        });
    }

    API = {
        debug: false,
        creds: creds,

    {{#each routes}}{{#if sdk.method}}
        {{sdk.method}}: function {{sdk.method}}(data, done) {
            {{#if lambda.arn}}
                invoke('{{lambda.arn}}', data, done);
            {{else}}
                console.warn('Lambda not deployed:', '{{sdk.method}}');
            {{/if}}
        },
    {{/if}}{{/each}}
    };

    return API;
};
